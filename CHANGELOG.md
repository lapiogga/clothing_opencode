# Changelog

모든 주요 변경사항은 이 파일에 기록됩니다.

## [2026-02-20] - 0220 수정요청 9건 처리

### 변경 (Changed)
- **권한 수정**
  - `router/index.js`: 체척권 등록(`/tailor/register`)에서 admin 권한 제거
  - 체척권 등록은 체척업체(`tailor_company`)만 접근 가능

- **메뉴 구조 변경**
  - "체척권 취소 승인" 메뉴를 시스템 관리 → 체척권 관리로 이동
  - "반품 처리" 메뉴명을 "판매현황"으로 변경

- **관리자 체척권 현황 화면** (`VoucherList.vue`)
  - admin 권한 시 사용자 검색 버튼 추가
  - 전체 체척권 조회 가능

- **대시보드** (`Dashboard.vue`)
  - 마운트 시 `authStore.fetchUser()` 호출로 포인트 최신화

### 수정 (Fixed)
- **백엔드 API** (`tailor.py`)
  - admin 권한 시 user_id 필터 제거 (전체 조회 가능)

### 수정 요청 처리 결과

| # | 요청 사항 | 상태 |
|---|---------|------|
| 1 | 군수담당자 체척권 등록 권한 제거 | ✅ |
| 2 | 관리자 체척권현황 사용자 검색 | ✅ |
| 3 | 체척권 취소 승인 메뉴 이동 | ✅ |
| 4 | 체척업체 체척권현황 사용자정보 | ✅ (이미 구현됨) |
| 5 | 체척업체 체척권등록 완제품 표시 | ✅ (이미 필터 적용됨) |
| 6 | 반품처리 메뉴명 변경 | ✅ |
| 7 | 일반사용자 체척권 조회 탭 | ✅ (이미 구현됨) |
| 8 | 대시보드 새로고침 | ✅ |

### 문서화
- **요구사항 정의서** (`docs/requirements.md`)
  - 시스템 요구사항 명세서 작성
  - 역할별 권한 매트릭스, 기능적 요구사항, 포인트 처리 규칙 포함

- **포인트 정합성 테스트 결과서** (`docs/test-results.md`)
  - 5회 반복 테스트 결과 상세 기록

- **화면간 정합성 테스트 결과서** (`docs/test-screen-integrity.md`)
  - 10회 반복 테스트 결과 상세 기록

---

## [2026-02-20] - 화면간 정합성 테스트 및 버그 수정

### 추가 (Added)
- **화면간 정합성 테스트** (`backend/test_screen_integrity.py`)
  - 10회 반복 테스트 (220개 테스트 케이스)
  - 사용자/품목/주문/오프라인판매/체척권/재고/스키마/권한 테스트
  - 100% 성공률 달성

- **화면간 정합성 테스트 결과서** (`docs/test-screen-integrity.md`)
  - 테스트 범위, 결과, 검증 항목 상세 기록

### 수정 (Fixed)
- **사용자 생성 오류** (`user_service.py`)
  - `service_years` 속성 참조 오류 수정 (property이므로 제거)

- **품목 삭제 오류** (`clothing_service.py`)
  - JOIN 구문 수정: `"order_items"` → `OrderItem` 모델 사용

- **오프라인 판매 재고 차감 오류** (`sales_service.py`)
  - `order.items` 관계 미로딩 문제 해결
  - `order_items_list` 리스트로 직접 전달

### 검증 결과 (10회 반복)
```
총계: 220/220 통과 (0 실패)
성공률: 100.0%
```

---

## [2026-02-20] - 포인트 시스템 정합성 개선

### 추가 (Added)
- **포인트 시스템 정합성 테스트** (`backend/test_point_integrity.py`)
  - 온라인 구매/오프라인 구매/체척권 발행/체척권 취소 5회 반복 검증
  - 포인트 차감/복원, 재고 차감 검증

### 변경 (Changed)
- **온라인 구매 포인트 처리**
  - 주문 생성 시: 예약 포인트 증가 (보유 포인트 유지)
  - 수령 완료 시: 보유 포인트 차감 + 예약 포인트 해제

- **오프라인 구매 포인트 처리**
  - 구매 즉시 보유 포인트 차감
  - 재고 즉시 차감

- **체척권 발행 포인트 처리**
  - 발행 시: 보유 포인트 즉시 차감
  - 취소 승인 시: 보유 포인트 복원

- **피복 쇼핑 화면 (Shop.vue)**
  - 보유/예약/사용가능 포인트 표시
  - 사용가능 포인트 범위 내에서만 구매 가능

- **order_service.py**
  - `order.items` → `order_items_list` 변경 (관계 미로딩 문제 해결)

### 수정 (Fixed)
- **마이너스 포인트 방지**
  - 모든 포인트 작업에서 사용 가능 포인트 검증
  - `available_point = current_point - reserved_point`

- **오프라인 구매 재고 차감**
  - 주문 생성 시 `order.items`가 비어있던 문제 수정

### 검증 결과 (5회 반복)
```
온라인 구매: 5/5 성공
오프라인 구매: 5/5 성공
체척권 발행: 5/5 성공
체척권 취소 승인: 5/5 성공
```

### 포인트 처리 규칙

| 작업 | 보유 포인트 | 예약 포인트 | 사용가능 포인트 |
|------|------------|------------|----------------|
| 온라인 구매 생성 | 유지 | 증가 | 감소 (검증) |
| 온라인 구매 수령 | 감소 | 감소 | 유지 |
| 오프라인 구매 | 감소 | 유지 | 감소 |
| 체척권 발행 | 감소 | 유지 | 감소 |
| 체척권 취소 승인 | 증가 | 유지 | 증가 |

---

## [2026-02-20] - 체척권 취소 승인 기능 및 통계 화면 개선

### 추가 (Added)
- **체척권 취소 승인 기능**
  - `VoucherStatus.CANCEL_REQUESTED` 상태 추가 (취소 요청됨)
  - 관리자용 체척권 취소 승인 화면 (`/admin/voucher-cancellations`)
  - 취소 승인 시 포인트 자동 환불 기능
  - 취소 반려 기능 (원래 상태로 복구)

- **체척권 목록 화면** (`/user/vouchers`)
  - 사용자 체척권 조회 기능
  - 상태별 필터링 (발행됨/등록됨/사용완료/취소됨)
  - 체척권 취소 요청 기능

- **배송지 관리 화면** (`/sales/delivery-locations`)
  - 판매소 배송지 등록/수정/삭제

- **대시보드 통계 API** (`/api/stats/dashboard`)
  - 역할별 맞춤 통계 제공

- **판매 통계 API** (`/api/stats/sales`)
  - 일별 판매 추이, 인기 상품, 카테고리별 비중

### 변경 (Changed)
- **체척권 취소 프로세스 개선**
  - 기존: 즉시 취소 처리
  - 변경: 취소 요청 → 관리자 승인 → 취소 완료 (포인트 환불)

- **체척권 등록 시 상태 검증 강화**
  - 취소 요청/취소됨 상태의 체척권 등록 차단

- **통계 화면 UI 개선**
  - 미니멀 디자인 적용
  - 기간 선택 기능 (주간/월간/분기)
  - CSS 기반 차트 (바 차트, 도넛 차트)
  - 로딩 스피너 추가
  - 반응형 레이아웃

- **직접 배송 기능**
  - "직접 수령" → "직접 배송"으로 명칭 변경
  - 배송지 선택 기능 추가

### 수정 (Fixed)
- **사용자 검색 API 권한**
  - `/api/users/search` 엔드포인트 추가
  - 판매소, 체척업체 권한 허용

- **체척업체 목록 API**
  - `manager_phone` 필드 제거 (모델에 없음)

- **메뉴 권한**
  - 체척권 관리 메뉴에 admin 권한 추가

- **UserResponse 스키마**
  - `sales_office_id`, `tailor_company_id` 필드 추가

### API 변경사항

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/api/users/search` | GET | 사용자 검색 (판매소, 체척업체 권한) |
| `/api/tailor-vouchers/{id}/approve-cancel` | POST | 체척권 취소 승인/반려 |
| `/api/stats/dashboard` | GET | 대시보드 통계 |
| `/api/stats/sales` | GET | 판매 통계 |
| `/api/delivery-locations` | POST | 배송지 등록 |
| `/api/delivery-locations/{id}` | PUT | 배송지 수정 |
| `/api/delivery-locations/{id}` | DELETE | 배송지 삭제 |

### 체척권 상태 흐름

```
발행됨 (issued)
    ├─→ 등록됨 (registered) → 사용완료 (used)
    │
    └─→ 취소요청 (cancel_requested)
            ├─→ 취소됨 (cancelled) [포인트 환불]
            └─→ 발행됨 (issued) [반려 시 복구]
```

### 체크사항

#### 오류 수정
- [x] 체척업체 목록 조회 시 `manager_phone` 필드 오류 수정
- [x] 재고 부족 품목 조회 시 property 비교 오류 수정
- [x] 사용자 검색 API 권한 문제 수정

#### 정책 변경
- [x] 체척권 취소 시 관리자 승인 필요
- [x] 취소 승인 시에만 포인트 환불
- [x] 취소 반려 시 원래 상태로 복구

#### 기능 검증
- [x] Frontend Build 성공
- [x] Backend API 응답 정상
- [x] Git Commit 완료
- [x] GitHub Push 완료

---

## [2026-02-18] - 초기 릴리즈

### 추가 (Added)
- 사용자 관리 (CRUD)
- 피복 품목 관리
- 카테고리 관리
- 피복판매소 관리
- 체척업체 관리
- 포인트 지급
- 오프라인 판매
- 재고 관리
- 피복 쇼핑
- 주문 관리
